<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bocce Game</title>
    <style>
        body {
            font-family: monospace;
            background-color: black;
            color: white;
        }
        pre {
            white-space: pre-wrap;
        }
        input, button {
            font-family: monospace;
            background-color: black;
            color: white;
            border: 1px solid white;
        }
    </style>
</head>
<body>
    <pre id="intro_text">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BOCCE
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CREATIVE COMPUTING
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MORRISTOWN NEW JERSEY



THIS GAME SIMULATES THE GAME OF LAWN BOWLS
DO YOU NEED INSTRUCTIONS? ENTER YES OR NO:
    </pre>

    <div id="instructions_section">
        <input type="text" id="instruction_input" required>
        <button onclick="submitInstruction()">Submit</button>
        <pre id="instructions_text"></pre>
    </div>

    <div id="game_section" style="display:none;">
        <pre>THE JACK IS LOCATED AT 2203  199</pre>

        <div id="result_section">
            <!-- Результаты и вводы velocity/angle будут здесь -->
            <pre id="result_output"></pre>
        </div>

        <div id="input_section">
            <pre id="input_label">VELOCITY?</pre> <!-- Убрали лишний BALL N -->
            <input type="number" id="input_value" required><br><br>
        </div>

        <button type="button" id="submit_button" onclick="submitTurn()">Submit</button>
    </div>

    <script>
        let current_ball = 1;
        let current_step = "velocity";
        let all_results = ''; // Храним все результаты

        function submitInstruction() {
            const instructionInput = document.getElementById("instruction_input").value.trim().toUpperCase();
            fetch("/get_instructions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ instruction: instructionInput })
            })
            .then(response => response.json())
            .then(data => {
                // Отображаем ответ пользователя (YES или NO) в конце строки, сохраняя форматирование
                const introText = document.getElementById("intro_text").innerHTML;
                document.getElementById("intro_text").innerHTML = introText.trim() + ` ${instructionInput}`;

                // Если ответ YES, отображаем инструкции
                if (instructionInput === "YES") {
                    document.getElementById("instructions_text").innerText = data.instructions;
                } else if (instructionInput === "NO") {
                    // Добавляем отступ строки, если ответ NO
                    document.getElementById("intro_text").innerHTML += "<br><br>";
                }

                // Независимо от ответа, показываем блок с игрой
                document.getElementById("game_section").style.display = "block";

                // Убираем форму ввода и кнопку
                document.getElementById("instruction_input").style.display = "none";
                document.getElementById("instructions_section").querySelector("button").style.display = "none";
            });
        }

        function submitTurn() {
            const input_value = document.getElementById("input_value").value;

            fetch("/play_turn", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ [current_step]: input_value })
            })
            .then(response => response.json())
            .then(data => {
                if (current_step === "velocity") {
                    // Добавляем BALL N и VELOCITY в общий вывод только для скорости
                    all_results += `BALL ${current_ball}\nVELOCITY? ${input_value}\n`;

                    // Обновляем вывод всех шаров
                    document.getElementById("result_output").innerText = all_results;

                    // Переходим к вводу угла
                    current_step = "angle";
                    document.getElementById("input_value").value = "";
                    document.getElementById("input_label").innerText = `ANGLE?`;

                } else if (current_step === "angle") {
                    // Добавляем ANGLE и результат текущего шара в общий вывод
                    all_results += `ANGLE? ${input_value}\n${data.result}\n`;
                    if (data.comment) {
                        all_results += `${data.comment}\n`;
                    }

                    // Обновляем вывод всех шаров
                    document.getElementById("result_output").innerText = all_results;

                    // Проверяем, есть ли еще шары
                    if (data.next_ball <= 4) {
                        current_ball = data.next_ball;
                        current_step = "velocity";
                        document.getElementById("input_value").value = "";
                        document.getElementById("input_label").innerText = `VELOCITY?`;

                        // Обновляем текст для нового шара только после завершения текущего
                        document.getElementById("result_output").innerText += `\nBALL ${current_ball}`;
                    } else {
                        // Если шары закончились, выводим сообщение о завершении и убираем кнопку
                        document.getElementById("input_section").style.display = "none";
                        document.getElementById("submit_button").style.display = "none"; // Убираем кнопку после завершения
                        all_results += `\nTHE TOTAL DISTANCE OF ALL BALLS FROM THE JACK IS ${data.total_distance.toFixed(4)} CM\nDON'T PLAY THIS GAME FOR MONEY!!\nCARE TO TRY AGAIN? ENTER YES OR NO?`;
                        document.getElementById("result_output").innerText = all_results;

                        // Добавляем ввод для повторного ответа (YES или NO)
                        const retryInput = document.createElement("input");
                        retryInput.type = "text";
                        retryInput.id = "retry_input";
                        retryInput.required = true;

                        const retryButton = document.createElement("button");
                        retryButton.innerText = "Submit";
                        retryButton.onclick = retryGame;

                        document.body.appendChild(retryInput);
                        document.body.appendChild(retryButton);
                    }
                }

                // Перемещаем поле ввода всегда вниз, под результат
                document.getElementById("input_section").scrollIntoView({ behavior: "smooth" });
            });
        }

        function retryGame() {
            const retryInput = document.getElementById("retry_input").value.trim().toUpperCase();
            if (retryInput === "YES") {
                location.reload(); // Перезагружаем игру
            } else {
                alert("Спасибо за игру!");
            }
        }
    </script>
</body>
</html>
